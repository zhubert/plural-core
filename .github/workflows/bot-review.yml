name: Bot Review Status

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

permissions:
  statuses: write
  pull-requests: read

jobs:
  bot-review-status:
    runs-on: ubuntu-latest

    steps:
      - name: Set status check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const review = context.payload.review;

            // Helper: map review state to commit status
            function resolveReviewState(reviewState, reviewUrl) {
              const s = reviewState.toUpperCase();
              if (s === 'APPROVED') {
                return { state: 'success', description: 'Bot approved the changes', targetUrl: reviewUrl };
              } else if (s === 'CHANGES_REQUESTED') {
                return { state: 'failure', description: 'Bot requested changes', targetUrl: reviewUrl };
              }
              return null; // COMMENTED or other non-decisive states
            }

            // Helper: find the most recent decisive bot review via API
            async function findDecisiveReview() {
              const reviews = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const botReviews = reviews.data
                .filter(r => r.user.login === 'shipitai[bot]')
                .sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at));

              for (const r of botReviews) {
                const result = resolveReviewState(r.state, r.html_url);
                if (result) return result;
              }
              return null;
            }

            let state, description, targetUrl;

            if (review && review.user.login === 'shipitai[bot]') {
              // Bot review submitted - check if it's a decisive review
              const result = resolveReviewState(review.state, review.html_url);
              if (result) {
                ({ state, description, targetUrl } = result);
              } else {
                // COMMENTED - not a decision, check for prior decisive review
                const prior = await findDecisiveReview();
                if (prior) {
                  ({ state, description, targetUrl } = prior);
                } else {
                  state = 'pending';
                  description = 'Bot commented, waiting for approval or rejection';
                  targetUrl = review.html_url;
                }
              }
            } else {
              // PR opened/updated - find most recent decisive bot review
              const result = await findDecisiveReview();
              if (result) {
                ({ state, description, targetUrl } = result);
              } else {
                state = 'pending';
                description = 'Waiting for bot review';
                targetUrl = pr.html_url;
              }
            }

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.head.sha,
              state: state,
              target_url: targetUrl,
              description: description,
              context: 'bot-review'
            });
